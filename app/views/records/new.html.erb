<details class="usage-details">
  <summary>
    <h2>ã€ğŸŒ±ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹ã€‘</h2>
  </summary>
  <div class="record-description">
    <%= image_tag "howtouse.png", alt: "ä½¿ã„æ–¹", class: "howtouse2" %>
  </div>
</details>

<div class="record-time">
  <% if current_user %>
    <% if current_user.first_record_date.present? %>
      <p>ç¾åœ¨è¨˜éŒ² <%= current_user.days_since_first_record %> æ—¥ç›®</p>
      <p>åˆè¨ˆ <%= current_user.total_record_duration_hours %> æ™‚é–“è¨˜éŒ²ã—ãŸã‚ˆğŸŒ±</p>
    <% else %>
      <p>ã¾ã è¨˜éŒ²ãŒãªã„ã¿ãŸã„ï¼æœ€åˆã®è¨˜éŒ²ã‚’å§‹ã‚ã‚ˆã†ğŸŒ±</p>
    <% end %>
  <% else %>
    <p>è¨˜éŒ²ã‚’ã¤ã‘ã¦ã€èŠ±ã‚’è‚²ã¦ã¦ã¿ã‚ˆã†ï¼</p>
  <p>
  <% end %>
</div>
<br>

<%# === ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒé–¢é€£ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ™‚é–“è¨˜éŒ²ç”¨ï¼‰ã“ã“ã‹ã‚‰ === %>
<%= form_with model: @record, url: records_path, data: { turbo: false }, id: "time_record_form" do |f| %>
  <div id="timer-section" data-flower-id="<%= @user_flower.id %>">
    <div id="timer">00:00:00</div>
    <div class="timer-controls">
      <button type="button" id="start" class="btn-start">é–‹å§‹</button>
      <button type="button" id="stop" class="btn-stop">åœæ­¢</button>
      <button type="button" id="record_time_submit" class="btn-record">è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <div id="seed-image" style="display: none;">
      <img src="<%= asset_path('Sprout.png') %>" alt="èŠ±ã®ç¨®" />
    </div>
  </div>

  <%= f.hidden_field :time, id: "record_time_field" %>
<% end %>
<%# === ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒé–¢é€£ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ™‚é–“è¨˜éŒ²ç”¨ï¼‰ã“ã“ã¾ã§ === %>

<div
  id="flower-message"
  data-flash-message="<%= j(flash[:notice] || flash[:alert]) %>"
  data-flash-image="<%= image_path(flash[:flower_image]) if flash[:flower_image].present? %>"
  data-flowerseeds-url="<%= image_url('Flowerseeds.png') %>"
  data-sprout-url="<%= image_url('Sprout.png') %>"
  data-bud-url="<%= image_url('Bud.gif') %>"
  data-fullbloom1-url="<%= image_url('FullBloom1.png') %>"
  data-fullbloom2-url="<%= image_url('FullBloom2.png') %>"
  data-fullbloom3-url="<%= image_url('FullBloom3.png') %>"
  data-fullbloom4-url="<%= image_url('FullBloom4.png') %>"
  data-fullbloom5-url="<%= image_url('FullBloom5.png') %>"
  data-thanks-url="<%= image_url('Thanks.png') %>"
  class="message hidden">
</div>

<hr>

<h2>ToDoãƒªã‚¹ãƒˆ</h2>

<%# === ToDoã‚¿ã‚¹ã‚¯è¿½åŠ ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ  ã“ã“ã‹ã‚‰ === %>
<div class="todo-section">
  <%# ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒã€ŒTODOã‚’è¿½åŠ ã€ã™ã‚‹å½¹å‰²ã‚’æ‹…ã†ã‚ˆã€‚ %>
  <%= form_with model: @record, url: records_path, data: { turbo_stream: true }, id: "new_record_form", class: "todo-form" do |f| %>
    <div id="record_errors">
      <% if @record.errors.any? %>
        <div class="error-messages">
          <h4><%= pluralize(@record.errors.count, "ã‚¨ãƒ©ãƒ¼") %>:</h4>
          <ul>
            <% @record.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <div class="field form-group">
      <%= f.label :task_name, "æ–°ã—ã„ToDoã‚’è¿½åŠ ", class: "form-label" %><br />
      <%= f.text_field :task_name, data: { autofocus: true }, class: "form-input", placeholder: "ä¾‹: ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã€éƒ¨å±‹ã®æƒé™¤" %>
    </div>

    <%# ã“ã® submit ãƒœã‚¿ãƒ³ãŒã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹ã‚ˆ %>
    <%= f.submit "ToDoã‚’è¿½åŠ ", class: "btn-add-todo" %>
  <% end %>

  <%# === ToDoãƒªã‚¹ãƒˆè¡¨ç¤ºéƒ¨åˆ† ã“ã“ã‹ã‚‰ === %>
  <div class="todo-list-container" id="todo-list">
    <h3>æœªå®Œäº†ã®ToDo</h3>
    <ul id="todo_items" class="todo-list">
      <%= render partial: 'record', collection: @records %>
    </ul>
  </div>
  <%# === ToDoãƒªã‚¹ãƒˆè¡¨ç¤ºéƒ¨åˆ† ã“ã“ã¾ã§ === %>
  <%= link_to "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼/ã‚°ãƒ©ãƒ•ã¸", analytics_records_path, class: "btn-calendar" %>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.js"></script>

<script>

// ã‚¢ãƒ—ãƒªã‚’ä½¿ã„å§‹ã‚ãŸå®Ÿéš›ã®æ—¥ä»˜ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
const startDate = new Date('<%= current_user.created_at.strftime('%Y-%m-%dT%H:%M:%S') %>'); 
const today = new Date();

// çµŒéæ—¥æ•°ã‚’è¨ˆç®—ã—ã¾ã™
const diffTime = Math.abs(today.getTime() - startDate.getTime());
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

// çµŒéæ—¥æ•°ãŒ7æ—¥ç›®ã®å ´åˆã®ã¿ã€ç´™å¹é›ªã‚’é™ã‚‰ã›ã¾ã™
if (diffDays === 7) {
    var duration = 15 * 1000;
    var animationEnd = Date.now() + duration;
    var skew = 1;

    function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
    }

    (function frame() {
        var timeLeft = animationEnd - Date.now();
        var ticks = Math.max(200, 500 * (timeLeft / duration));
        skew = Math.max(0.8, skew - 0.001);

        confetti({
            particleCount: 1,
            startVelocity: 0,
            ticks: ticks,
            origin: {
                x: Math.random(),
                y: (Math.random() * skew) - 0.2
            },
            colors: ['#ffa4c2ff'],
            shapes: ['circle'],
            gravity: randomInRange(0.4, 0.6),
            scalar: randomInRange(0.4, 1),
            drift: randomInRange(-0.4, 0.4)
        });

        if (timeLeft > 0) {
            requestAnimationFrame(frame);
        }
    }());
}
</script>